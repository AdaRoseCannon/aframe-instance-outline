{"version":3,"file":"aframe-instance-outline.js","sources":["../src/InstancedSkinnedMesh.js","../src/aframe-instance-outline.js"],"sourcesContent":["/* jshint esversion: 9, -W097 */\n/* For dealing with spline curves */\n/* global THREE, AFRAME, setTimeout, console */\n'use strict';\nimport { InstancedBufferAttribute, SkinnedMesh , Matrix4 } from 'three';\n\nconst _instanceLocalMatrix = /*@__PURE__*/ new Matrix4();\nconst _instanceWorldMatrix = /*@__PURE__*/ new Matrix4();\n\nconst _instanceIntersects = [];\n\nclass InstancedSkinnedMesh extends SkinnedMesh {\n\n\tconstructor( geometry, material, count ) {\n\n\t\tsuper( geometry, material );\n\n\t\tthis.instanceMatrix = new InstancedBufferAttribute( new Float32Array( count * 16 ), 16 );\n\t\tthis.instanceColor = null;\n\n\t\tthis.count = count;\n\n\t\tthis.frustumCulled = false;\n\n\t\tthis._mesh = null;\n\n\t}\n\n\tcopy( source ) {\n\n\t\tsuper.copy( source );\n\n\t\tif ( source.isInstancedMesh ) {\n\n\t\t\tthis.instanceMatrix.copy( source.instanceMatrix );\n\n\t\t\tif ( source.instanceColor !== null ) this.instanceColor = source.instanceColor.clone();\n\n\t\t\tthis.count = source.count;\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\tgetColorAt( index, color ) {\n\n\t\tcolor.fromArray( this.instanceColor.array, index * 3 );\n\n\t}\n\n\tgetMatrixAt( index, matrix ) {\n\n\t\tmatrix.fromArray( this.instanceMatrix.array, index * 16 );\n\n\t}\n\n\traycast( raycaster, intersects ) {\n\n\t\tconst matrixWorld = this.matrixWorld;\n\t\tconst raycastTimes = this.count;\n\n\t\tif ( this._mesh === null ) {\n\n\t\t\tthis._mesh = new SkinnedMesh( this.geometry, this.material );\n\t\t\tthis._mesh.copy( this );\n\n\t\t}\n\n\t\tconst _mesh = this._mesh;\n\n\t\tif ( _mesh.material === undefined ) return;\n\n\t\tfor ( let instanceId = 0; instanceId < raycastTimes; instanceId ++ ) {\n\n\t\t\t// calculate the world matrix for each instance\n\n\t\t\tthis.getMatrixAt( instanceId, _instanceLocalMatrix );\n\n\t\t\t_instanceWorldMatrix.multiplyMatrices( matrixWorld, _instanceLocalMatrix );\n\n\t\t\t// the mesh represents this single instance\n\n\t\t\t_mesh.matrixWorld = _instanceWorldMatrix;\n\n\t\t\t_mesh.raycast( raycaster, _instanceIntersects );\n\n\t\t\t// process the result of raycast\n\n\t\t\tfor ( let i = 0, l = _instanceIntersects.length; i < l; i ++ ) {\n\n\t\t\t\tconst intersect = _instanceIntersects[ i ];\n\t\t\t\tintersect.instanceId = instanceId;\n\t\t\t\tintersect.object = this;\n\t\t\t\tintersects.push( intersect );\n\n\t\t\t}\n\n\t\t\t_instanceIntersects.length = 0;\n\n\t\t}\n\n\t}\n\n\tsetColorAt( index, color ) {\n\n\t\tif ( this.instanceColor === null ) {\n\n\t\t\tthis.instanceColor = new InstancedBufferAttribute( new Float32Array( this.instanceMatrix.count * 3 ), 3 );\n\n\t\t}\n\n\t\tcolor.toArray( this.instanceColor.array, index * 3 );\n\n\t}\n\n\tsetMatrixAt( index, matrix ) {\n\n\t\tmatrix.toArray( this.instanceMatrix.array, index * 16 );\n\n\t}\n\n\tupdateMorphTargets() {\n\n\t}\n\n\tdispose() {\n\n\t\tthis.dispatchEvent( { type: 'dispose' } );\n\n\t}\n\n}\n\nInstancedSkinnedMesh.prototype.isInstancedMesh = true;\n\nexport { InstancedSkinnedMesh };\n","/* jshint esversion: 9, -W097 */\n/* For dealing with spline curves */\n/* global THREE, AFRAME, setTimeout, console */\n'use strict';\n\nimport { InstancedSkinnedMesh } from './InstancedSkinnedMesh.js';\n\nexport function onBeforeCompile( shader ) {\n\tshader.vertexShader = shader.vertexShader.replace('void main() {', `\n\t#include <normal_pars_vertex>\n\tflat varying float instanceID;\n\t#ifdef FLAT_SHADED\n\t\tvarying vec3 vNormal;\n\t#endif\n\tvoid main() {\n\t`);\n\n\tshader.vertexShader = shader.vertexShader\n\t.replace('#include <project_vertex>',`\n\tinstanceID = float(gl_InstanceID);\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#ifdef FLAT_SHADED\n\t\tvNormal = normalize( transformedNormal );\n\t#endif\n\tvec4 mvPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_INSTANCING\n\t\tmvPosition = instanceMatrix * mvPosition;\n\t#endif\n\tmvPosition = modelViewMatrix * mvPosition;\n\tmvPosition += vec4(vNormal * 0.015 * instanceID, .0);\n\tgl_Position = projectionMatrix * mvPosition;\n\t`);\n\n\tshader.fragmentShader = shader.fragmentShader.replace('void main() {', `\n\tflat varying float instanceID;\n\tvoid main() {\n\t\tif (instanceID == 1. && gl_FrontFacing) discard;\n\t`);\n\t\t\n\tshader.fragmentShader = shader.fragmentShader.replace('vec4 diffuseColor = vec4( diffuse, opacity );', `\n\t\tvec4 diffuseColor = vec4(mix(vec3(0.), vec3(1.), instanceID), opacity);\n\t`);\n\n}\n\nconst tempMatrix = new THREE.Matrix4().makeScale(1,1,1);\nexport function makeOutline(object) {\n\tconst after = [];\n\tobject.traverse(o => {\n\t\tif (\n\t\t\t(o instanceof THREE.Mesh) &&\n\t\t\t!(o instanceof THREE.InstancedMesh || o instanceof InstancedSkinnedMesh)\n\t\t) {\n\t\t\tconst mat = new THREE.MeshBasicMaterial({\n\t\t\t\tcolor: o.material.color,\n\t\t\t\tonBeforeCompile: onBeforeCompile,\n\t\t\t\tside: THREE.DoubleSide,\n\t\t\t\ttransparent: false,\n\t\t\t\tblending: THREE.AdditiveBlending\n\t\t\t});\n\t\t\tconst newMesh = o instanceof THREE.SkinnedMesh ?\n\t\t\t\tnew InstancedSkinnedMesh(o.geometry, mat, 2):\n\t\t\t\tnew THREE.InstancedMesh(o.geometry, mat, 2);\n\n\t\t\to.updateMatrixWorld();\n\t\t\tnewMesh.setMatrixAt(0, tempMatrix);\n\t\t\tnewMesh.setMatrixAt(1, tempMatrix);\n\n\t\t\tconst array = o.parent.children;\n\t\t\tconst index = array.indexOf(o);\n\n\t\t\tnewMesh.children = o.children;\n\t\t\tnewMesh.parent = o.parent;\n\n\t\t\tafter.push(() => array[index] = newMesh);\n\t\t}\n\t});\n\tfor (const fn of after) fn();\n}\n\nAFRAME.registerComponent('outline', {\n\tschema: {},\n\tinit() {\n\t\tthis.onLoad = () => makeOutline(this.el.object3D);\n\t\tthis.el.addEventListener('object3dset', this.onLoad);\n\t\tthis.onLoad();\n\t}\n});\n"],"names":["Matrix4","SkinnedMesh","InstancedBufferAttribute"],"mappings":"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"}